when:
  - event: ['push']
    branch: ['main']
  - event: ['manual']

engine: 'nixery'

clone:
  skip: false
  depth: 1

dependencies:
  nixpkgs:
    # Needed to retrieve wisp
    - coreutils
    - curl
    # My dependencies
    - go
    - proj
    - libwebp
    # CGo
    - gcc
    - gnumake
    - pkg-config

environment:
  SITE_NAME: shutup.jp
  WISP_HANDLE: byjp.me

steps:
  - name: Build site
    command: go run .

  - name: Download wisp
    command: |
      curl https://sites.wisp.place/nekomimi.pet/wisp-cli-binaries/wisp-cli-x86_64-linux -o wisp-cli
      chmod +x wisp-cli

  - name: Upload site
    command: |
      ./wisp-cli \
        "$WISP_HANDLE" \
        --path "./dist" \
        --site "$SITE_NAME" \
        --password "$WISP_APP_PASSWORD"