when:
  - event: ['push']
    branch: ['main']
  - event: ['manual']

engine: 'nixery'

clone:
  skip: false
  depth: 1

dependencies:
  nixpkgs:
    # Needed to retrieve wisp
    - coreutils
    - findutils
    - curl
    # My dependencies
    - go
    - proj.dev
    - libwebp
    # CGo
    - stdenv.cc
    - pkg-config

environment:
  SITE_NAME: shutup.jp
  WISP_HANDLE: byjp.me

steps:

  - name: Build site
    # TODO: figure out how to properly get nix to have proj.dev register with pkg-config
    command: |
      export PKG_CONFIG_PATH="$(pkg-config --variable pc_path pkg-config)"
      for pkg in proj libwebp; do
        export PKG_CONFIG_PATH="$(find /nix/store -name "$pkg.pc" -exec dirname {} \; | head -1):$PKG_CONFIG_PATH"
      done
      export CGO_ENABLED=1
      go run .

  - name: Download wisp
    command: |
      curl https://sites.wisp.place/nekomimi.pet/wisp-cli-binaries/wisp-cli-x86_64-linux -o wisp-cli
      chmod +x wisp-cli

  - name: Upload site
    command: |
      ./wisp-cli \
        "$WISP_HANDLE" \
        --path "./dist" \
        --site "$SITE_NAME" \
        --password "$WISP_APP_PASSWORD"